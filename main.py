from jsonio import JsonUtil
from submit import BondChain

if __name__ == "__main__":
    # convert data to json
    src_txt = 'test/1.txt'  # generated by Tencent QQ
    dst_json = 'test/1.json'
    src_bmap = 'assets/bank_map.json'
    # JsonUtil.convert_txt_to_json(src_txt, dst_json, src_bmap)
    # initialize
    src_conf = 'assets/conf.json'
    src_user = 'assets/user.json'
    bc = BondChain(src_conf, src_user)
    # login
    bc.login()
    # load data
    src_rmap = 'assets/bank_rank.json'
    data = JsonUtil.load(dst_json)
    rmap = JsonUtil.load(src_rmap)
    failed = []
    # traverse data, add one offer each iteration
    for bank in data:
        if not bc.add_offer(bank, rmap): failed.append(bank)
    # print failed offers
    if failed:
        print(f'* Totally {len(failed)} failed:')
        for fail in failed:
            print(fail)
    # done and quit
    bc.done()
